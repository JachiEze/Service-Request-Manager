@model IEnumerable<ServiceRequestForm.Models.ServiceRequest>
@using Microsoft.AspNetCore.Mvc.Rendering

@{
    ViewBag.Title = "Validator Page";
}

<div class="content-wrapper">
    @if (Model != null && Model.Any())
    {
        <div class="d-flex justify-content-end mb-3">
            <form method="get" action="@Url.Action("Index", "User2")" class="d-flex" style="max-width:350px;">
                <input type="text" name="search" class="form-control me-2" value="@Context.Request.Query["search"]" />
                <button type="submit" class="btn btn-outline-primary">Search</button>
            </form>
        </div>
    }
@if (TempData["Notification"] != null)
{
    <div id="popupNotification" class="alert alert-success" style="position:fixed;top:20px;right:20px;z-index:9999;min-width:200px;">
        @TempData["Notification"]
    </div>
    <script>
        setTimeout(function() {
            var popup = document.getElementById('popupNotification');
            if (popup) popup.style.display = 'none';
        }, 2500);
    </script>
}
<div class="d-flex justify-content-center align-items-center" style="min-height: 80vh;">
    <div class="card shadow-lg w-100" style="max-width: 700px;">

        <div class="card-body">
            @if (Model == null || !Model.Any())
            {
                <div class="w-100 py-4" style="background-color: #e3f2fd; border-radius: 8px; text-align: center; font-size: 1.2rem; font-weight: 500; margin-bottom: 1rem;">
                    No forms pending validation.
                </div>
            }
            else
            {
                @foreach (var form in Model)
                {
                    <form asp-action="UpdateForm" method="post">
                        <input type="hidden" name="Id" value="@form.Id" />
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Request Title</label>
                                <input name="RequestTitle" value="@form.RequestTitle" class="form-control" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Entity</label>
                                <select name="Entity"
                                        asp-items="@(new SelectList(((Dictionary<string, string[]>)ViewBag.Entities).Keys, form.Entity))"
                                        id="entitySelect-@form.Id"
                                        class="form-select">
                                    <option value="">-- Select Entity --</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Department</label>
                                <select name="Department" id="departmentSelect-@form.Id" class="form-select">
                                    <option value="">-- Select Department --</option>
                                    @if (!string.IsNullOrEmpty(form.Entity) && ((Dictionary<string, string[]>)ViewBag.Entities).ContainsKey(form.Entity))
                                    {
                                        foreach (var dept in ((Dictionary<string, string[]>)ViewBag.Entities)[form.Entity])
                                        {
                                            <option value="@dept" selected="@(form.Department == dept)">@dept</option>
                                        }
                                    }
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Number of Personnel</label>
                                <input name="NumberOfPersonnel" value="@form.NumberOfPersonnel" class="form-control" type="number" />
                            </div>
                            <div class="col-12">
                                <label class="form-label">Service Description</label>
                                <textarea name="ServiceDescription" class="form-control">@form.ServiceDescription</textarea>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Proposed Service Start Date</label>
                                <input name="ProposedServiceStartDate"
                                       value="@(form.ProposedServiceStartDate.ToString("yyyy-MM-dd"))"
                                       class="form-control"
                                       type="date"
                                       min="@DateTime.Today.AddDays(7).ToString("yyyy-MM-dd")" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Personnel Type</label>
                                <select name="PersonnelType"
                                        asp-items="@(new SelectList(ViewBag.PersonnelTypes, form.PersonnelType))"
                                        class="form-select">
                                    <option value="">-- Select Personnel Type --</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Location</label>
                                <select name="Location"
                                        asp-items="@(new SelectList(ViewBag.Locations, form.Location))"
                                        class="form-select">
                                    <option value="">-- Select Location --</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Service Scheme</label>
                                <select name="ServiceScheme"
                                        asp-items="@(new SelectList(ViewBag.ServiceSchemes, form.ServiceScheme))"
                                        class="form-select">
                                    <option value="">-- Select Service Scheme --</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Cost Centre</label>
                                <select name="CostCentre"
                                        asp-items="@(new SelectList(((Dictionary<string, string[]>)ViewBag.CostCentres).Keys, form.CostCentre))"
                                        id="costCentreSelect-@form.Id"
                                        class="form-select">
                                    <option value="">-- Select Cost Centre --</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">GL Account</label>
                                <select name="GlAccount" id="glAccountSelect-@form.Id" class="form-select">
                                    <option value="">-- Select GL Account --</option>
                                    @if (!string.IsNullOrEmpty(form.CostCentre) && ((Dictionary<string, string[]>)ViewBag.CostCentres).ContainsKey(form.CostCentre))
                                    {
                                        foreach (var gl in ((Dictionary<string, string[]>)ViewBag.CostCentres)[form.CostCentre])
                                        {
                                            <option value="@gl" selected="@(form.GlAccount == gl)">@gl</option>
                                        }
                                    }
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Job Impact</label>
                                <select name="JobImpact"
                                        asp-items="@(new SelectList(ViewBag.JobImpacts, form.JobImpact))"
                                        class="form-select">
                                    <option value="">-- Select Job Impact --</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Budget Owner</label>
                                <input name="BudgetOwner" value="@form.BudgetOwner" class="form-control" />
                            </div>
                            <div class="col-12">
                                <label class="form-label">User Comment</label>
                                <textarea name="User1Comment" class="form-control" readonly>@form.User1Comment</textarea>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Validator Comment</label>
                                <textarea name="User2Comment" class="form-control">@form.User2Comment</textarea>
                            </div>
                        </div>
                        <div class="text-end mt-4">
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                            <button type="submit" class="btn btn-success ms-2" formaction="@Url.Action("SendToUser3")">Send to Approver</button>
                            <button type="submit" class="btn btn-warning ms-2" formaction="@Url.Action("ReturnToUser1")">Return to User</button>
                        </div>
                    </form>
                }
            }
        </div>
    </div>
</div>
</div>


<script>
    var entityMap = @Html.Raw(System.Text.Json.JsonSerializer.Serialize<Dictionary<string, string[]>>(
        (Dictionary<string, string[]>)ViewBag.Entities
    ));

    var costCentreMap = @Html.Raw(System.Text.Json.JsonSerializer.Serialize<Dictionary<string, string[]>>(
        (Dictionary<string, string[]>)ViewBag.CostCentres
    ));

    document.querySelectorAll("[id^='entitySelect-']").forEach(function (entityDropdown) {
        entityDropdown.addEventListener("change", function () {
            var formId = this.id.split('-')[1];
            var selectedEntity = this.value;
            var deptSelect = document.getElementById("departmentSelect-" + formId);
            deptSelect.innerHTML = '<option value="">-- Select Department --</option>';

            if (entityMap[selectedEntity]) {
                entityMap[selectedEntity].forEach(function (dept) {
                    var opt = document.createElement("option");
                    opt.value = dept;
                    opt.textContent = dept;
                    deptSelect.appendChild(opt);
                });
            }
        });
    });

    document.querySelectorAll("[id^='costCentreSelect-']").forEach(function (costCentreDropdown) {
        costCentreDropdown.addEventListener("change", function () {
            var formId = this.id.split('-')[1];
            var selectedCostCentre = this.value;
            var glSelect = document.getElementById("glAccountSelect-" + formId);
            glSelect.innerHTML = '<option value="">-- Select GL Account --</option>';

            if (costCentreMap[selectedCostCentre]) {
                costCentreMap[selectedCostCentre].forEach(function (gl) {
                    var opt = document.createElement("option");
                    opt.value = gl;
                    opt.textContent = gl;
                    glSelect.appendChild(opt);
                });
            }
        });
    });
</script>










